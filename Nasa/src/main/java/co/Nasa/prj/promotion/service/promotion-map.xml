<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.Nasa.prj.promotion.service.PromotionMapper">

<insert id="promotionInsert" parameterType="co.Nasa.prj.comm.VO.PromotionVO">
	<selectKey keyProperty="pro_code" resultType="string" order="BEFORE">
      SELECT NVL(MAX(TO_NUMBER(pro_code)),0)+1 FROM PROMOTION   
   </selectKey>
	INSERT INTO PROMOTION
	VALUES(#{pro_code},#{s_email},#{prodiscount},#{pro_start}, #{pro_end}, #{pro_service},#{pro_status})
</insert>

<select id="promotionList" resultType="co.Nasa.prj.comm.VO.PromotionVO">
	select p.*, s.ser_title, s.ser_img 
	from promotion p, service s 
	where p.pro_service = s.ser_code
	and s.s_email = #{s_email}
	order by p.pro_start desc
</select>

<select id="endPromotion" resultType="co.Nasa.prj.comm.VO.PromotionVO">
	<![CDATA[
	SELECT MAX(PRO_END) 
	FROM PROMOTION 
	WHERE PRO_SERVICE = #{pro_service}
	AND TO_CHAR(SYSDATE, 'YYYY-MM-DD') < PRO_END]]>
</select>

<select id="promotionCheck" resultType="co.Nasa.prj.comm.VO.PromotionVO">
	<!-- SELECT *
	FROM PROMOTION
	WHERE PRO_SERVICE = #{pro_service} 
	AND #{pro_start} BETWEEN PRO_START AND PRO_END -->
	<![CDATA[
	SELECT * FROM PROMOTION WHERE PRO_SERVICE = #{pro_service} 
	AND (#{pro_start} >= pro_start and #{pro_start} <= pro_end
	OR #{pro_end} >= pro_start and #{pro_end} <= pro_end) 
	AND pro_status <> 'Y']]>
</select>

<delete id="promotionCancel" parameterType="co.Nasa.prj.comm.VO.PromotionVO">
	DELETE FROM PROMOTION
	WHERE PRO_SERVICE = #{pro_service} AND PRO_CODE = #{pro_code}
</delete>

<update id="promotionEnd" parameterType="co.Nasa.prj.comm.VO.PromotionVO">
	UPDATE PROMOTION SET 
	PRO_STATUS = 'Y', PRO_END = sysdate
	WHERE PRO_SERVICE = #{pro_service} AND PRO_CODE = #{pro_code}
</update>

<update id="startCheckPromotion">
	<![CDATA[
	UPDATE PROMOTION 
	SET PRO_STATUS='N' 
	WHERE PRO_START <= TO_CHAR(sysdate,'yyyy-mm-dd')
	AND PRO_STATUS = 'U']]>
</update>

<update id="endCheckPromotion">
	<![CDATA[
	UPDATE PROMOTION 
	SET PRO_STATUS = 'Y' 
	WHERE PRO_END < SYSDATE 
	AND PRO_STATUS = 'N']]>
</update>

<select id="promotionSelectList" resultType="co.Nasa.prj.comm.VO.PromotionVO">
	<![CDATA[
	SELECT *
	FROM PROMOTION
	WHERE S_EMAIL = #{s_email}
	AND PRO_SERVICE = #{pro_service}
	AND PRO_END >= #{pro_end}
	AND PRO_STATUS <> 'Y']]>
</select>

<update id="serviceEndPromotion" parameterType="co.Nasa.prj.comm.VO.PromotionVO">
	UPDATE PROMOTION SET 
	PRO_STATUS = 'Y' , PRO_END = #{pro_end}
	WHERE PRO_SERVICE = #{pro_service} AND PRO_CODE = #{pro_code}
</update>

<update id="serviceEndPromotion2" parameterType="co.Nasa.prj.comm.VO.PromotionVO">
	UPDATE PROMOTION SET 
	PRO_END = #{pro_end}
	WHERE PRO_SERVICE = #{pro_service} AND PRO_CODE = #{pro_code}
</update>
</mapper>